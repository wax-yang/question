##### 服务启动不成功的一个原因

1. BaseSvr下行情中心数据查询接口编写完成后，启动服务对每个接口进行测试，测试结果是ok的。

   

2. 测试完最后一个接口后，服务突然停了，尝试启动也没有成功

   ![img](https://www.tapd.cn/tfl/captures/2021-01/tapd_personalword_1167499660001000187_base64_1609924076_88.png)

   

3. 因为测试完后，将所有的Cache文件移动到Cache目录下，考虑是不是因为这个情况导致的，但是编译是可以通过的，所以这个情况是没有影响的。

   

4. 接着，排查日志。日志排查没有发现啥情况，有两个Error，一个是dump错误，一个是缓存数据为空。这个其实不应该报Error，提示个Warn就可以了。

   

5. 接着，重新审阅代码。代码其实也是没啥问题的，因为之前也没有改动，只是单纯移动了文件。

   

6. 然后查询对应的core文件。在frank帮忙，查看结果如下，可以发现，主要是readFromResults函数出现了问题，该函数对应的this=0x0，说明程序被终止了。

   ![img](https://www.tapd.cn/tfl/captures/2021-01/tapd_personalword_1167499660001000187_base64_1609924897_54.png)

   程序被终止时因为出现了异常错误，从而调用Commutil类下的sleepAndAbort函数，最终调用abort函数，将程序终止掉

   ![img](https://www.tapd.cn/tfl/captures/2021-01/tapd_personalword_1167499660001000187_base64_1609925303_87.png)

7. 但是readFromResults本身逻辑是没有错误，接着从每一个接口进行排查，将所有接口调用注释掉，每次开放一个或几个接口排查。最终定位到盘中估值这个接口。

   ![img](https://www.tapd.cn/tfl/captures/2021-01/tapd_personalword_1167499660001000187_base64_1609925527_38.png)



8. 然后定位到日志，日志打印加载的记录fund_code为空，定位到readFromResults函数下。说明我们加载fund_code这个主键为空。对于empty函数，最终判断的是string的长度是否为0。但是这种情况本质上不应该出现，然后去查询数据库。

   ![img](https://www.tapd.cn/tfl/captures/2021-01/tapd_personalword_1167499660001000187_base64_1609925655_15.png)



9. 定位到t_fund_pzgz表，发现确定有一条测试数据，主键没有值，因为主键的定位是not null，默认值为''。这就导致了判断结果为空。从而导致错误，服务不能启动。将该数据删除，服务即可启动成功。



10. 考虑修改代码逻辑。当主键有空的时候，不考虑将该数据写入到缓存，即不进行报错，直接continue即可。

    ![img](https://www.tapd.cn/tfl/captures/2021-01/tapd_personalword_1167499660001000187_base64_1609931768_44.png)





